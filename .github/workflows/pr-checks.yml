name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-title-check:
    name: Check PR Title
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Types: build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test
          types: |
            build
            chore
            ci
            docs
            feat
            fix
            perf
            refactor
            revert
            style
            test
          requireScope: false
          
  pr-size-check:
    name: Check PR Size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          
      - name: Get PR file changes
        id: files
        uses: Ana06/get-changed-files@v2.3.0
        
      - name: Check PR size
        run: |
          FILES_CHANGED=$(echo "${{ steps.files.outputs.all }}" | wc -w)
          echo "Files changed: $FILES_CHANGED"
          if [ $FILES_CHANGED -gt 50 ]; then
            echo "::warning::This PR changes $FILES_CHANGED files. Consider breaking it into smaller PRs for easier review."
          fi

  pre-commit:
    name: Run pre-commit hooks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          
      - name: Install Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 20
          
      - name: Enable Corepack
        run: corepack enable
        
      - name: Prepare pnpm
        run: corepack prepare pnpm@9.12.0 --activate
        
      - name: Get pnpm store directory
        id: pnpm-store
        run: |
          echo "dir=$(pnpm store path)" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.dir }}
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile
        
      - name: Install uv
        run: pip install uv
        
      - name: Install Python dependencies
        run: |
          uv venv
          uv pip install -e .[dev]
          
      - name: Cache pre-commit hooks
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          
      - name: Run pre-commit
        run: |
          source .venv/bin/activate
          pre-commit run --all-files
